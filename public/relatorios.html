<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - Pesquisa Condições de Trabalho</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pesquisa sobre Condições de Trabalho</h1>
            <nav>
                <a href="index.html">Formulário</a>
                <a href="relatorios.html" class="active">Relatórios</a>
                <a href="admin.html">Administração</a>
            </nav>
        </header>

        <div class="reports-container">
            <div class="report-header">
                <h2>Relatório de Respostas</h2>
                <div class="report-actions">
                    <button onclick="baixarGraficos()" class="btn-primary btn-export">Baixar Gráficos</button>
                    <button onclick="exportarCSV()" class="btn-secondary btn-export">Exportar CSV</button>
                    <button onclick="exportarJSON()" class="btn-secondary btn-export">Exportar JSON</button>
                </div>
            </div>

            <!-- Resumo estatístico -->
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="number" id="totalRespostas">0</div>
                    <div class="label">Total de Respostas</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="ultimaResposta">-</div>
                    <div class="label">Última Resposta</div>
                </div>
            </div>

            <div id="loadingMessage" class="loading">Carregando dados...</div>

            <div id="graficos-container">
            <!-- Questão 11 -->
            <div class="chart-section">
                <h3>11 – Grau de realização da autonomia profissional</h3>
                <div class="chart-container" id="chart-q11"></div>
            </div>

            <!-- Questão 12 -->
            <div class="chart-section">
                <h3>12 – Instrumentos utilizados no cotidiano profissional</h3>
                <div class="chart-container" id="chart-q12"></div>
            </div>

            <!-- Questão 13 -->
            <div class="chart-section">
                <h3>13 – Viés do serviço oferecido na instituição</h3>
                <div class="chart-container" id="chart-q13"></div>
            </div>

            <!-- Questão 14 - Diálogo -->
            <div class="chart-section">
                <h3>14 – Há diálogo multidisciplinar?</h3>
                <div class="chart-container" id="chart-q14-dialogo"></div>
            </div>

            <!-- Questão 14 - Formato -->
            <div class="chart-section">
                <h3>14 – Formato da relação de poder e saber</h3>
                <div class="chart-container" id="chart-q14-formato"></div>
            </div>

            <!-- Questão 15 -->
            <div class="chart-section">
                <h3>15 – Como ocorre o planejamento do trabalho</h3>
                <div class="chart-container" id="chart-q15"></div>
            </div>

            <!-- Questão 16 - Gráfico Consolidado -->
            <div class="chart-section">
                <h3>16 – Condições de Trabalho (Consolidado)</h3>
                <div class="chart-container" id="chart-q16-consolidado"></div>
            </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Carregar relatórios ao abrir a página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const respostas = await getRespostas();

                // Esconder loading
                document.getElementById('loadingMessage').style.display = 'none';

                // Atualizar estatísticas
                document.getElementById('totalRespostas').textContent = respostas.length;

                if (respostas.length > 0) {
                    const ultima = respostas[0]; // Já vem ordenado DESC
                    const data = new Date(ultima.dataEnvio);
                    document.getElementById('ultimaResposta').textContent =
                        data.toLocaleDateString('pt-BR');
                }

                // Gerar gráficos
                gerarGraficoBarras('chart-q11', contarRespostas(respostas, 'q11'));
                gerarGraficoBarras('chart-q12', contarRespostas(respostas, 'q12'));
                gerarGraficoBarras('chart-q13', contarRespostas(respostas, 'q13'));
                gerarGraficoBarras('chart-q14-dialogo', contarRespostas(respostas, 'q14_dialogo'));
                gerarGraficoBarras('chart-q14-formato', contarRespostas(respostas, 'q14_formato'));
                gerarGraficoBarras('chart-q15', contarRespostas(respostas, 'q15'));

                // Questão 16 - Gráfico consolidado
                gerarGraficoConsolidadoQ16('chart-q16-consolidado', respostas);
            } catch (error) {
                console.error('Erro ao carregar relatórios:', error);
                document.getElementById('loadingMessage').textContent = 'Erro ao carregar dados';
            }
        });

        // Função para baixar todos os gráficos como imagens separadas em ZIP
        async function baixarGraficos() {
            const btn = event.target;

            // Feedback visual
            btn.textContent = 'Gerando imagens...';
            btn.disabled = true;

            try {
                const zip = new JSZip();
                const chartSections = document.querySelectorAll('.chart-section');

                // Nomes dos arquivos para cada gráfico
                const nomes = [
                    'Q11_Autonomia_Profissional',
                    'Q12_Instrumentos_Cotidiano',
                    'Q13_Vies_Servico',
                    'Q14_Dialogo_Multidisciplinar',
                    'Q14_Formato_Relacao',
                    'Q15_Planejamento_Trabalho',
                    'Q16_Condicoes_Trabalho_Consolidado'
                ];

                // Gerar cada gráfico como imagem
                for (let i = 0; i < chartSections.length; i++) {
                    const section = chartSections[i];

                    const canvas = await html2canvas(section, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });

                    // Converter para blob e adicionar ao ZIP
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    zip.file(`${nomes[i]}.png`, blob);

                    // Atualizar progresso
                    btn.textContent = `Gerando ${i + 1}/${chartSections.length}...`;
                }

                // Gerar e baixar o ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.download = `graficos_pesquisa_${new Date().toISOString().split('T')[0]}.zip`;
                link.href = URL.createObjectURL(zipBlob);
                link.click();

                btn.textContent = 'Baixar Gráficos';
                btn.disabled = false;
            } catch (error) {
                console.error('Erro ao gerar imagens:', error);
                alert('Erro ao gerar imagens dos gráficos');
                btn.textContent = 'Baixar Gráficos';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
